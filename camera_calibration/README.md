# 카메라 캘리브레이션

## 파라미터

### 카메라 내부 파라미터 행렬 (Camera Intrinsic Matrix)

$$
K = \begin{bmatrix}
f_x & 0 & c_x \\
0 & f_y & c_y \\
0 & 0 & 1
\end{bmatrix}
$$

- $f_x, f_y$: 초점 거리 (focal length, 픽셀 단위)
- $c_x, c_y$: 주점 (principal point, 이미지 중심)

### 렌즈 왜곡 모델 파라미터

$$
\mathbf{d} = [k_1, k_2, p_1, p_2, k_3]
$$

- $k_1, k_2, k_3$: Radial distortion (방사형 왜곡)
- $p_1, p_2$: Tangential distortion (접선 왜곡)

## 모델

### 핀홀 카메라 모델 (Pinhole Camera Model)

카메라 캘리브레이션은 핀홀 카메라 모델을 기반으로 합니다. 3D 공간의 점 $P = (X, Y, Z)$가 2D 이미지의 점 $p = (u, v)$로 투영되는 과정은 다음과 같습니다:

$$
\begin{bmatrix}
u \\
v \\
1
\end{bmatrix}
= \frac{1}{Z} K \begin{bmatrix}
X \\
Y \\
Z
\end{bmatrix}
= \frac{1}{Z} \begin{bmatrix}
f_x & 0 & c_x \\
0 & f_y & c_y \\
0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
X \\
Y \\
Z
\end{bmatrix}
$$

이를 풀어쓰면:

- $u = f_x \frac{X}{Z} + c_x$
- $v = f_y \frac{Y}{Z} + c_y$

이는 3D 점의 $X, Y$ 좌표를 깊이 $Z$로 나눈 후, 초점 거리로 스케일링하고 주점만큼 이동시키는 과정입니다.

### 렌즈 왜곡 모델 (Lens Distortion Model)

실제 렌즈는 이상적인 핀홀 모델과 달리 왜곡을 일으킵니다. 왜곡을 보정하기 위해 다음 과정을 거칩니다:

#### 1. 정규화된 이미지 좌표 계산

먼저 카메라 중심에서의 정규화된 좌표를 구합니다:

$$
x = \frac{X}{Z}, \quad y = \frac{Y}{Z}
$$

#### 2. 왜곡 적용

정규화된 좌표에 왜곡을 적용합니다:

$$
\begin{align}

x_{distorted} &= x(1 + k_1 r^2 + k_2 r^4 + k_3 r^6) + 2p_1 xy + p_2(r^2 + 2x^2) \\
y_{distorted} &= y(1 + k_1 r^2 + k_2 r^4 + k_3 r^6) + p_1(r^2 + 2y^2) + 2p_2 xy \\
\end{align}
\\
r^2 = x^2 + y^2
$$

여기서:

- $r$: 중심으로부터의 거리 (radial distance)
- $(1 + k_1 r^2 + k_2 r^4 + k_3 r^6)$: 방사 왜곡 (거리에 따른 왜곡)
- $2p_1 xy + p_2(r^2 + 2x^2)$와 $p_1(r^2 + 2y^2) + 2p_2 xy$: 접선 왜곡 (렌즈 정렬 오차)

#### 3. 최종 픽셀 좌표

왜곡된 좌표를 카메라 행렬로 변환하여 최종 픽셀 좌표를 얻습니다:

$$
\begin{align}
u &= f_x \cdot x_{distorted} + c_x \\
v &= f_y \cdot y_{distorted} + c_y
\end{align}
$$

캘리브레이션은 이 과정을 역으로 풀어서, 이미지에서 관찰된 체크보드 패턴의 왜곡된 점들로부터 $K$와 왜곡 계수 $[k_1, k_2, p_1, p_2, k_3]$를 추정하는 과정입니다.

## 캘리브레이션

### 캘리브레이션 방법

1. 이미지 수집
   - `collect_images.py` 이용
   - s키를 눌러서 체크보드 촬영
   - 10 ~ 20장 정도의 이미지 필요
   - 체크보드의 내부 교차점 개수는 가로, 세로가 비대칭이어야 함
2. 캘리브레이션
   - `calibrate.py` 이용

### 캘리브레이션 결과

<img src="img_14.jpg"/>

실제 측정값은 아래와 같습니다.

```
Camera Matrix (K):
[[1.28424584e+03 0.00000000e+00 6.26095811e+02]
 [0.00000000e+00 1.28356036e+03 3.78255028e+02]
 [0.00000000e+00 0.00000000e+00 1.00000000e+00]]

Distortion Coefficients (dist):
[[ 1.28749707e-01  6.10940494e-01  5.58299262e-03 -1.02942722e-03
  -3.71134263e+00]]
```

### 결과 해석

#### 초점 거리 ($f_x$, $f_y$)

- **$f_x$**: 가로 방향의 초점 거리
- **$f_y$**: 세로 방향의 초점 거리
- 초점 거리가 클수록 렌즈의 줌(확대) 효과가 큽니다
- $f_x$와 $f_y$가 다른 이유는 카메라 센서의 픽셀이 정사각형이 아닐 수 있기 때문입니다
- 일반적으로 두 값이 비슷하면 정상적인 카메라입니다

#### 주점 ($c_x$, $c_y$)

- **$c_x$**: 이미지 중심의 가로 좌표
- **$c_y$**: 이미지 중심의 세로 좌표
- 이상적으로는 이미지의 정중앙이지만, 렌즈 제조 과정에서 약간의 오차가 발생할 수 있습니다
- 광학 중심(optical center)이 이미지 중심과 정확히 일치하지 않는 경우가 많습니다

#### 방사 왜곡 (Radial Distortion): $k_1, k_2, k_3$

- **$k_1$**: 1차 방사 왜곡 계수
- **$k_2$**: 2차 방사 왜곡 계수
- **$k_3$**: 3차 방사 왜곡 계수

방사 왜곡은 이미지 중심에서 멀어질수록 점들이 안쪽 또는 바깥쪽으로 휘는 현상입니다:

- **배럴 왜곡 (Barrel)**: $k_1 > 0$일 때, 직선이 바깥쪽으로 볼록하게 휩니다 (광각 렌즈에서 흔함)
- **핀쿠션 왜곡 (Pincushion)**: $k_1 < 0$일 때, 직선이 안쪽으로 오목하게 휩니다

#### 접선 왜곡 (Tangential Distortion): $p_1, p_2$

- **$p_1$**: 1차 접선 왜곡 계수
- **$p_2$**: 2차 접선 왜곡 계수

접선 왜곡은 렌즈와 이미지 센서가 완벽하게 평행하지 않을 때 발생합니다:

- 렌즈 제조 과정에서 렌즈가 약간 기울어지거나 조립 오차로 발생
- 일반적으로 방사 왜곡보다 영향이 작습니다
